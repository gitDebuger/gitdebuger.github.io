import{_ as s,c as a,a as e,o as p}from"./app-HtfM32JZ.js";const t={};function l(c,n){return p(),a("div",null,n[0]||(n[0]=[e(`<h1 id="lab3实验报告" tabindex="-1"><a class="header-anchor" href="#lab3实验报告"><span>Lab3实验报告</span></a></h1><h2 id="_1-思考题" tabindex="-1"><a class="header-anchor" href="#_1-思考题"><span>1. 思考题</span></a></h2><h3 id="_1-1-thinking-3-1" tabindex="-1"><a class="header-anchor" href="#_1-1-thinking-3-1"><span>1.1 Thinking 3.1</span></a></h3><p><strong>结合MOS中的页目录自映射应用解释代码中 <code>e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_V</code> 的含义。</strong></p><p>以只读权限在 <code>UVPT</code> 映射它自己的页表。因此，用户程序可以通过 <code>UVPT</code> 读取它的页表。</p><p>这段代码的功能是填写进程页目录的自映射表项。</p><p>左侧展开后为 <code>e-&gt;env_pgdir[(UPVT&gt;&gt;PDSHIFT)&amp;0x03FF]</code> 也就是获取自映射页目录项。自映射页目录项地址的计算公式如下： $$ PDE_self_mapping=PD_base+(PT_base&gt;&gt;22&lt;&lt;2) $$ 这里的 <code>env_pgdir</code> 就相当于公式中的 <code>PD_base</code> 而 <code>UVPT</code> 就相当于公式中的 <code>PT_base</code> ，其余的相加以及左移操作已经由数组 <code>[]</code> 运算符完成。即将被赋值的就是自映射页目录项。</p><p>自映射页目录项由物理页号和标志位组成，通过 <code>PADDR</code> 我们得到了页目录的物理地址，也就是物理页号左移后的结果。然后通过或运算将权限 <code>PTE_V</code> 写入标志位。</p><p>所以这条语句的作用就是填写页目录自映射页目录项，包括物理页号或者物理地址，以及对应的只读权限。</p><h3 id="_1-2-thinking-3-2" tabindex="-1"><a class="header-anchor" href="#_1-2-thinking-3-2"><span>1.2 Thinking 3.2</span></a></h3><p><strong><code>elf_load_seg</code> 以函数指针的形式，接受外部自定义的回调函数 <code>map_page</code> 。请你找到与之相关的 <code>data</code> 这一参数在此处的来源，并思考它的作用。没有这个参数可不可以？为什么？</strong></p><p>这里的 <code>data</code> 来自于调用者 <code>load_icode</code> 函数中的参数 <code>struct Env *e</code> ，这个参数是由 <code>env_create</code> 函数传递给 <code>load_icode</code> 函数的。在 <code>env_create</code> 函数中，我们通过调用 <code>env_alloc</code> 函数获取了一个空闲的进程控制块结构体，然后将这个进程控制块结构体传递给了 <code>load_icode</code> 函数。</p><p>在 <code>elf_load_seg</code> 中，我们循环将 <code>data</code> 传递给 <code>map_page</code> 以将数据加载到用户地址空间，这里的 <code>map_page</code> 来自于调用者 <code>load_icode</code> 函数，其值为 <code>load_icode_mapper</code> 函数。</p><p>如果没有这个参数，那么在 <code>elf_load_seg</code> 函数中就无法调用 <code>load_icode_mapper</code> 函数，就无法完成加载数据的工作。</p><h3 id="_1-3-thinking-3-3" tabindex="-1"><a class="header-anchor" href="#_1-3-thinking-3-3"><span>1.3 Thinking 3.3</span></a></h3><p><strong>结合 <code>elf_load_seg</code> 的参数和实现，考虑该函数需要处理哪些页面加载的情况。</strong></p><p>该函数主要分为三步：</p><ul><li>第一步，将 <code>va</code> 前面与 <code>PAGE_SIZE</code> 不对齐的部分，按照原有偏移量加载到页面中。如果 <code>va</code> 已经与 <code>PAGE_SIZE</code> 对齐，则在该步骤中无加载操作。</li><li>第二步，将 <code>va</code> 后面的数据通过循环逐页加载到页面中。</li><li>第三步，如果数据大小 <code>bin_size</code> 小于段大小 <code>sgsize</code> ，则循环创建空页进行填充。</li></ul><p>所以分支的来源包括 <code>va</code> 所处位置以及数据大小，具体类型如下：</p><ol><li><code>va</code> 与 <code>PAGE_SIZE</code> 未对齐 <ol><li><code>bin_size</code> 小于 <code>PAGE_SIZE-offset</code><ol><li><code>bin_size</code> 小于 <code>sg_size</code></li><li><code>bin_size</code> 大于 <code>sg_size</code></li></ol></li><li><code>bin_size</code> 大于 <code>PAGE_SIZE-offset</code><ol><li><code>bin_size</code> 小于 <code>sg_size</code></li><li><code>bin_size</code> 大于 <code>sg_size</code></li></ol></li></ol></li><li><code>va</code> 与 <code>PAGE_SIZE</code> 对齐 <ol><li><code>bin_size</code> 小于 <code>sg_size</code></li><li><code>bin_size</code> 大于 <code>sg_size</code></li></ol></li></ol><p>共六种情况。</p><h3 id="_1-4-thinking-3-4" tabindex="-1"><a class="header-anchor" href="#_1-4-thinking-3-4"><span>1.4 Thinking 3.4</span></a></h3><p><strong>你认为这里的 <code>env_tf.cp0_epc</code> 存储的是物理地址还是虚拟地址?</strong></p><p>存储的应该是虚拟地址。</p><p>实验指导书中有提到：</p><blockquote><p>在4Kc上，软件访存的虚拟地址会先被MMU硬件映射到物理地址，随后使用物理地址来访问内存或其他外设。</p></blockquote><p>也就是说我们访存使用的所有地址都是虚拟地址。</p><h3 id="_1-5-thinking-3-5" tabindex="-1"><a class="header-anchor" href="#_1-5-thinking-3-5"><span>1.5 Thinking 3.5</span></a></h3><p>这些异常处理函数定义在 <code>kern/genex.S</code> 中。</p><p>其中 <code>handle_int</code> 函数直接定义，内容如下：</p><div class="language-assembly line-numbers-mode" data-highlighter="prismjs" data-ext="assembly" data-title="assembly"><pre class="language-assembly"><code><span class="line">NESTED(handle_int, TF_SIZE, zero)</span>
<span class="line">	/* 首先读取CP0_CAUSE和CP0_STATUS寄存器的值 */</span>
<span class="line">	mfc0    t0, CP0_CAUSE</span>
<span class="line">	mfc0    t2, CP0_STATUS</span>
<span class="line">	/* 然后将其与操作以确定是否有中断被触发 */</span>
<span class="line">	and     t0, t2</span>
<span class="line">	andi    t1, t0, STATUS_IM7</span>
<span class="line">	/* 如果有中断被触发则跳转到 timer_irq 标签处处理定时器中断 */</span>
<span class="line">	bnez    t1, timer_irq</span>
<span class="line">timer_irq:</span>
<span class="line">	li      a0, 0</span>
<span class="line">	/* 最终调用 schedule 函数 */</span>
<span class="line">	j       schedule</span>
<span class="line">END(handle_int)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外两个 <code>handle_mod</code> 和 <code>handle_tlb</code> 异常处理函数，利用宏进行定义。</p><p>首先定义了一个宏，用于生成异常处理函数：</p><div class="language-assembly line-numbers-mode" data-highlighter="prismjs" data-ext="assembly" data-title="assembly"><pre class="language-assembly"><code><span class="line">.macro BUILD_HANDLER exception handler</span>
<span class="line">NESTED(handle_\\exception, TF_SIZE + 8, zero)</span>
<span class="line">	move    a0, sp</span>
<span class="line">	addiu   sp, sp, -8</span>
<span class="line">	jal     \\handler</span>
<span class="line">	addiu   sp, sp, 8</span>
<span class="line">	j       ret_from_exception</span>
<span class="line">END(handle_\\exception)</span>
<span class="line">.endm</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后调用这个宏，生成上述两个异常处理函数：</p><div class="language-assembly line-numbers-mode" data-highlighter="prismjs" data-ext="assembly" data-title="assembly"><pre class="language-assembly"><code><span class="line">BUILD_HANDLER tlb do_tlb_refill</span>
<span class="line">BUILD_HANDLER mod do_tlb_mod</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-thinking-3-6" tabindex="-1"><a class="header-anchor" href="#_1-6-thinking-3-6"><span>1.6 Thinking 3.6</span></a></h3><p><strong>阅读 <code>entry.S</code> 、 <code>genex.S</code> 和 <code>env_asm.S</code> 这几个文件，并尝试说出时钟中断在哪些时候开启，在哪些时候关闭。</strong></p><p>时钟中断在调度执行每一个进程之前开启，当触发时钟中断后，进入中断处理程序。此时时钟中断已经被关闭，需要重置时钟状态，才能重新开启时钟中断。</p><h3 id="_1-7-thinking-3-7" tabindex="-1"><a class="header-anchor" href="#_1-7-thinking-3-7"><span>1.7 Thinking 3.7</span></a></h3><p><strong>阅读相关代码，思考操作系统是怎么根据时钟中断切换进程的。</strong></p><p>在操作系统中，设置了一个进程就绪队列，并且给每一个进程添加了一个时间片，当进程的时间片消耗完，会触发硬件的时钟中断，进入对应的中断处理程序。中断处理程序会保存现场，并将这个进程移动到就绪队列的尾端，复原其时间片。然后让就绪队列最首端的进程执行相应的时间片，按照这种规律实现循环往复，从而做到根据时钟周期切换进程。</p><h2 id="_2-难点分析" tabindex="-1"><a class="header-anchor" href="#_2-难点分析"><span>2. 难点分析</span></a></h2><p><em><strong><s>这次实验全是难点</s></strong></em></p><h3 id="_2-1-课下实验" tabindex="-1"><a class="header-anchor" href="#_2-1-课下实验"><span>2.1 课下实验</span></a></h3><p>这次课下实验相比于Lab2没有增加太多文件，但是有很多函数调用了Lab2内存管理的函数，调用关系比较复杂。</p><p>另外，进程管理涉及内核态与用户态的切换，这部分需要通过硬件完成，有一些汇编代码需要编写，理解难度较大。</p><h3 id="_2-2-lab3-exam" tabindex="-1"><a class="header-anchor" href="#_2-2-lab3-exam"><span>2.2 Lab3-exam</span></a></h3><p><em><strong>这部分需要实现一个返回进程运行信息的函数，看起来很难，其实一点也不简单。</strong></em></p><p>需要修改的文件较多，而且需要理解各个文件的调用关系。</p><p><strong>首先是 <code>kern/env.c</code> 中添加如下代码：</strong></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre class="language-c"><code><span class="line"><span class="token keyword">void</span> <span class="token function">env_stat</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Env</span> <span class="token operator">*</span>e<span class="token punctuation">,</span> u_int <span class="token operator">*</span>pri<span class="token punctuation">,</span> u_int <span class="token operator">*</span>scheds<span class="token punctuation">,</span> u_int <span class="token operator">*</span>runs<span class="token punctuation">,</span> u_int <span class="token operator">*</span>clocks<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">/* 进程优先级 */</span></span>
<span class="line">	<span class="token operator">*</span>pri <span class="token operator">=</span> e<span class="token operator">-&gt;</span>env_pri<span class="token punctuation">;</span></span>
<span class="line">	<span class="token comment">/* 进程运行次数 */</span></span>
<span class="line">	<span class="token operator">*</span>runs <span class="token operator">=</span> e<span class="token operator">-&gt;</span>env_runs<span class="token punctuation">;</span></span>
<span class="line">	<span class="token comment">/* 进程调度次数 */</span></span>
<span class="line">	<span class="token operator">*</span>scheds <span class="token operator">=</span> e<span class="token operator">-&gt;</span>env_ipc_value<span class="token punctuation">;</span></span>
<span class="line">	<span class="token comment">/* 进程 CP0_COUNT 寄存器累加值 */</span></span>
<span class="line">	<span class="token operator">*</span>clocks <span class="token operator">=</span> e<span class="token operator">-&gt;</span>env_ipc_from<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这部分是函数的主体，为了让这个函数能获得正确的信息，还需要修改其他文件。</p><p><strong>对 <code>kern/sched.c</code> 中的函数做如下修改：</strong></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre class="language-c"><code><span class="line"><span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">int</span> yield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token keyword">struct</span> <span class="token class-name">Env</span> <span class="token operator">*</span>e <span class="token operator">=</span> curenv<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> <span class="token punctuation">(</span>yield <span class="token operator">||</span> count <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> e <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> e<span class="token operator">-&gt;</span>env_status <span class="token operator">!=</span> ENV_RUNNABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token function">TAILQ_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env_sched_list<span class="token punctuation">,</span> e<span class="token punctuation">,</span> env_sched_link<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>env_status <span class="token operator">==</span> ENV_RUNNABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token function">TAILQ_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env_sched_list<span class="token punctuation">,</span> e<span class="token punctuation">,</span> env_sched_link<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TAILQ_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env_sched_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: no runnable envs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		e <span class="token operator">=</span> <span class="token function">TAILQ_FIRST</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env_sched_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">/* Begin */</span></span>
<span class="line">		<span class="token comment">/* 复用 env_ipc_value 为调度次数计数器 */</span></span>
<span class="line">		<span class="token comment">/* 在发生进程调度时自增 1 */</span></span>
<span class="line">		e<span class="token operator">-&gt;</span>env_ipc_value<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">/* End */</span></span>
<span class="line">		count <span class="token operator">=</span> e<span class="token operator">-&gt;</span>env_pri<span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	count<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token comment">/* Begin */</span></span>
<span class="line">	<span class="token comment">/* 复用 env_ipc_from 为 CP0_COUNT 寄存器在每次时钟中断时的累加值 */</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">-&gt;</span>env_runs <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">/* 未运行过初始化为 0 */</span></span>
<span class="line">		e<span class="token operator">-&gt;</span>env_ipc_from <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">/* 此后每次调度累加 CP0_COUNT 寄存器的值 */</span></span>
<span class="line">		e<span class="token operator">-&gt;</span>env_ipc_from <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span> <span class="token operator">*</span><span class="token punctuation">)</span>KSTACKTOP <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>cp0_clock<span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token comment">/* End */</span></span>
<span class="line">	<span class="token function">env_run</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了方便，这里我没有在进程控制块中添加新的字段，而是复用了两个关于进程通信的字段，因为本次实验不涉及进程通信。</p><p><strong>然后需要在 <code>include/trap.h</code> 中的 <code>struct Trapframe</code> 中添加如下字段：</strong></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre class="language-c"><code><span class="line"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> cp0_clock<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>用于保存寄存器 <code>CP0_COUNT</code> 的值。</p><p><strong>并且在该文件的最后，添加并修改宏定义：</strong></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre class="language-c"><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TF_CLOCK</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>TF_EPC<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TF_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>TF_CLOCK<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>做完这些，在 <code>include/stackframe.h</code> 中添加如下指令，将 <code>CP0_COUNT</code> 寄存器的值存到陷入帧结构体中：</strong></p><div class="language-assembly line-numbers-mode" data-highlighter="prismjs" data-ext="assembly" data-title="assembly"><pre class="language-assembly"><code><span class="line">mfc0    k0, CP0_COUNT</span>
<span class="line">sw      k0, TF_CLOCK(sp)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>完成以上工作，这个实验代码就算完成了。</p><h3 id="_2-3-lab3-extra" tabindex="-1"><a class="header-anchor" href="#_2-3-lab3-extra"><span>2.3 Lab3-extra</span></a></h3><p>这个实验代码还是比较简单的，就是需要注意别忘了添加异常分发代码，还要修改异常向量组。</p><p><strong>首先在 <code>kern/genex.S</code> 中利用宏生成异常处理函数：</strong></p><div class="language-assembly line-numbers-mode" data-highlighter="prismjs" data-ext="assembly" data-title="assembly"><pre class="language-assembly"><code><span class="line">BUILD_HANDLER ri do_ri</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>然后在 <code>kern/traps.c</code> 中添加一些代码：</strong></p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre class="language-c"><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;env.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pmap.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;printk.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;trap.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_int</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_tlb</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_sys</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_mod</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_reserved</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* Begin Statement 1 */</span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">handle_ri</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* End Statement 1 */</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>exception_handlers<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_reserved<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_int<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">2</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_tlb<span class="token punctuation">,</span></span>
<span class="line">	<span class="token comment">/* Begin Statement 2 */</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_ri<span class="token punctuation">,</span></span>
<span class="line">	<span class="token comment">/* End Statement 2 */</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>LAB<span class="token punctuation">)</span> <span class="token operator">||</span> LAB <span class="token operator">&gt;=</span> <span class="token number">4</span></span></span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_mod<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> handle_sys<span class="token punctuation">,</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">do_reserved</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span> <span class="token operator">*</span>tf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token function">print_tf</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown ExcCode %2d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>cp0_cause <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* Begin Statement 3 */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">do_ri</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Trapframe</span> <span class="token operator">*</span>tf<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	u_int x <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tf<span class="token operator">-&gt;</span>cp0_epc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	u_int high <span class="token operator">=</span> x <span class="token operator">&gt;&gt;</span> <span class="token number">26</span><span class="token punctuation">;</span></span>
<span class="line">	u_int low <span class="token operator">=</span> x <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token punctuation">(</span>high <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		tf<span class="token operator">-&gt;</span>cp0_epc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">!=</span> <span class="token number">0x3f</span> <span class="token operator">&amp;&amp;</span> low <span class="token operator">!=</span> <span class="token number">0x3e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		tf<span class="token operator">-&gt;</span>cp0_epc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;&gt;</span> <span class="token number">6</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		tf<span class="token operator">-&gt;</span>cp0_epc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	u_int rs<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> rd<span class="token punctuation">;</span></span>
<span class="line">	rs <span class="token operator">=</span> x <span class="token operator">&gt;&gt;</span> <span class="token number">21</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">;</span></span>
<span class="line">	rt <span class="token operator">=</span> x <span class="token operator">&gt;&gt;</span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">;</span></span>
<span class="line">	rd <span class="token operator">=</span> x <span class="token operator">&gt;&gt;</span> <span class="token number">11</span> <span class="token operator">&amp;</span> <span class="token number">0x1f</span><span class="token punctuation">;</span></span>
<span class="line">	</span>
<span class="line">	u_int nrs <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>regs<span class="token punctuation">[</span>rs<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">	u_int nrt <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>regs<span class="token punctuation">[</span>rt<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">==</span> <span class="token number">0x3f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		u_int nrd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			u_int rs_i <span class="token operator">=</span> nrs <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0xff</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			u_int rt_i <span class="token operator">=</span> nrt <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0xff</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token keyword">if</span> <span class="token punctuation">(</span>rs_i <span class="token operator">&lt;</span> rt_i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				nrd <span class="token operator">=</span> nrd <span class="token operator">|</span> rt_i<span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">				nrd <span class="token operator">=</span> nrd <span class="token operator">|</span> rs_i<span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		tf<span class="token operator">-&gt;</span>regs<span class="token punctuation">[</span>rd<span class="token punctuation">]</span> <span class="token operator">=</span> nrd<span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">		u_int tmp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int <span class="token operator">*</span><span class="token punctuation">)</span>nrs<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> nrt<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_int <span class="token operator">*</span><span class="token punctuation">)</span>nrs<span class="token punctuation">)</span> <span class="token operator">=</span> tf<span class="token operator">-&gt;</span>regs<span class="token punctuation">[</span>rd<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		tf<span class="token operator">-&gt;</span>regs<span class="token punctuation">[</span>rd<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	tf<span class="token operator">-&gt;</span>cp0_epc <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">/* End Statement 3 */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这部分总体来说还是可以的，如果计组有好好学的话。</p><h2 id="_3-实验体会" tabindex="-1"><a class="header-anchor" href="#_3-实验体会"><span>3. 实验体会</span></a></h2><p>随着实验的继续，涉及的文件越来越多，调用关系越来越复杂。一定要理清各个文件和各个函数之间的关系，才能做好每次实验。</p>`,73)]))}const i=s(t,[["render",l],["__file","lab3.html.vue"]]),r=JSON.parse('{"path":"/blogs/OS/lab3.html","title":"Lab3实验报告","lang":"en-US","frontmatter":{"categories":["OS"]},"headers":[{"level":2,"title":"1. 思考题","slug":"_1-思考题","link":"#_1-思考题","children":[{"level":3,"title":"1.1 Thinking 3.1","slug":"_1-1-thinking-3-1","link":"#_1-1-thinking-3-1","children":[]},{"level":3,"title":"1.2 Thinking 3.2","slug":"_1-2-thinking-3-2","link":"#_1-2-thinking-3-2","children":[]},{"level":3,"title":"1.3 Thinking 3.3","slug":"_1-3-thinking-3-3","link":"#_1-3-thinking-3-3","children":[]},{"level":3,"title":"1.4 Thinking 3.4","slug":"_1-4-thinking-3-4","link":"#_1-4-thinking-3-4","children":[]},{"level":3,"title":"1.5 Thinking 3.5","slug":"_1-5-thinking-3-5","link":"#_1-5-thinking-3-5","children":[]},{"level":3,"title":"1.6 Thinking 3.6","slug":"_1-6-thinking-3-6","link":"#_1-6-thinking-3-6","children":[]},{"level":3,"title":"1.7 Thinking 3.7","slug":"_1-7-thinking-3-7","link":"#_1-7-thinking-3-7","children":[]}]},{"level":2,"title":"2. 难点分析","slug":"_2-难点分析","link":"#_2-难点分析","children":[{"level":3,"title":"2.1 课下实验","slug":"_2-1-课下实验","link":"#_2-1-课下实验","children":[]},{"level":3,"title":"2.2 Lab3-exam","slug":"_2-2-lab3-exam","link":"#_2-2-lab3-exam","children":[]},{"level":3,"title":"2.3 Lab3-extra","slug":"_2-3-lab3-extra","link":"#_2-3-lab3-extra","children":[]}]},{"level":2,"title":"3. 实验体会","slug":"_3-实验体会","link":"#_3-实验体会","children":[]}],"git":{"createdTime":1726994140000,"updatedTime":1726994140000,"contributors":[{"name":"gitDebuger","email":"hygchn04@gmail.com","commits":1}]},"filePathRelative":"blogs/OS/lab3.md"}');export{i as comp,r as data};
